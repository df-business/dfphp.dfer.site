/**
 * +----------------------------------------------------------------------
 * | 百度地图
 * +----------------------------------------------------------------------
 *                                            ...     .............
 *                                          ..   .:!o&*&&&&&ooooo&; .
 *                                        ..  .!*%*o!;.
 *                                      ..  !*%*!.      ...
 *                                     .  ;$$!.   .....
 *                          ........... .*#&   ...
 *                                     :$$: ...
 *                          .;;;;;;;:::#%      ...
 *                        . *@ooooo&&&#@***&&;.   .
 *                        . *@       .@%.::;&%$*!. . .
 *          ................!@;......$@:      :@@$.
 *                          .@!   ..!@&.:::::::*@@*.:..............
 *        . :!!!!!!!!!!ooooo&@$*%%%*#@&*&&&&&&&*@@$&&&oooooooooooo.
 *        . :!!!!!!!!;;!;;:::@#;::.;@*         *@@o
 *                           @$    &@!.....  .*@@&................
 *          ................:@* .  ##.     .o#@%;
 *                        . &@%..:;@$:;!o&*$#*;  ..
 *                        . ;@@#$$$@#**&o!;:   ..
 *                           :;:: !@;        ..
 *                               ;@*........
 *                       ....   !@* ..
 *                 ......    .!%$! ..     | AUTHOR: dfer
 *         ......        .;o*%*!  .       | EMAIL: df_business@qq.com
 *                .:;;o&***o;.   .        | QQ: 3504725309
 *        .;;!o&****&&o;:.    ..          | WEBSITE: http://www.dfer.site
 * +----------------------------------------------------------------------
 *
 */
class BMap extends Common {

    constructor() {
        super();
        console.log("DfTools", "BMap", "加载完成");
    }


    /**
     * http://developer.baidu.com/map/jsdemo.htm#a1_2
     * 自定义地图样式 http://developer.baidu.com/map/custom/
     * <div id="df"></div>
     * <style type="text/css">
     * #df {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}<!--这段样式不添加会导致地图不显示-->
     * </style>
     * <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=k5Z56pTgQE0d0iHqQQtY0aBbZ7McmDBO">
     * v2.0版本的引用方式：src="http://api.map.baidu.com/api?v=2.0&ak=您的密钥"
     * v1.4版本及以前版本的引用方式：src="http://api.map.baidu.com/api?v=1.4&key=您的密钥&callback=initialize"
     * </script>
     * var map = new BMap.Map("df");          // 创建地图实例
     * 
     * @param {Object} x
     * @param {Object} y
     */
    markBdMap(x, y) {
        //BdMap(116.404, 39.915)     //根据经纬度在地图上标注一个位置
        map.setMapStyle({
            style: 'bluish'
        }); //设置地图风格
        var myIcon = new BMap.Icon("http://developer.baidu.com/map/jsdemo/img/fox.gif", new BMap.Size(300,
            157)); //自定义图标

        var point = new BMap.Point(x, y); // 创建一个坐标（初始化地图时候的经纬度）
        map.centerAndZoom(point, 15); // 初始化地图，设置中心点坐标和地图缩放级别

        map.enableScrollWheelZoom(); //允许缩放
        map.addControl(new BMap.MapTypeControl({
            anchor: BMAP_ANCHOR_TOP_RIGHT
        })); //多种显示模式
        map.addControl(new BMap.NavigationControl()); //添加缩放平移控件
        map.addControl(new BMap.OverviewMapControl()); //缩略图
        map.addControl(new BMap.ScaleControl()); //添加比例尺控件

        var mk = new BMap.Marker(point, {
            icon: myIcon
        }); // 创建自定义图标的标注
        mk.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的标注
        map.addOverlay(mk); //添加标注
        map.panTo(point); //以某点为中心

    }

    /**
     * 根据浏览器定位地图
     */
    onlineBdMap() {
        //默认地图
        //	map.setMapStyle({
        //		//设置皮肤，参考网址：http://lbsyun.baidu.com/custom/list.htm
        //		style: 'googlelite'
        //	}); //设置地图风格

        //自定义地图

        map.setMapStyle({
            styleJson: [{
                "featureType": "land",
                "elementType": "geometry",
                "stylers": {
                    "visibility": "on",
                    "color": "#c7edcc"
                }
            }, {
                "featureType": "water",
                "elementType": "geometry",
                "stylers": {
                    "visibility": "on",
                    "color": "#4a90e2"
                }
            }]
        });
        // 自定义图标
        var myIcon = new BMap.Icon("https://api.map.baidu.com/images/marker_red_sprite.png", new BMap.Size(300,
            157));

        // ********************** 根据浏览器确定当前位置，进行定位 START **********************
        var geolocation = new BMap.Geolocation(); //创建浏览器定位
        geolocation.getCurrentPosition(function(r) {
            if (this.getStatus() == BMAP_STATUS_SUCCESS) { //检索成功则执行
                map.centerAndZoom(r.point, 15); // 初始化地图，设置中心点坐标和地图缩放级别

                map.enableScrollWheelZoom(); //允许缩放
                map.addControl(new BMap.MapTypeControl({
                    anchor: BMAP_ANCHOR_TOP_RIGHT
                })); //多种显示模式
                map.addControl(new BMap.NavigationControl()); //添加缩放平移控件
                map.addControl(new BMap.OverviewMapControl()); //缩略图
                map.addControl(new BMap.ScaleControl()); //添加比例尺控件

                Map.addMark(r.point); //添加标注
                //			console.log(r.point);
            } else {
                console.log('failed' + this.getStatus()); //返回状态码
            }
        });
        // **********************  根据浏览器确定当前位置，进行定位 END  **********************

        // ********************** 添加定位控件 START **********************

        //http://developer.baidu.com/map/reference/index.php?title=Class:%E6%8E%A7%E4%BB%B6%E7%B1%BB/GeolocationControlOptions
        var geolocationControl = new BMap.GeolocationControl({
            anchor: BMAP_ANCHOR_BOTTOM_LEFT,
            //		offset: new BMap.Size(10, 100),
            //		locationIcon: myIcon,
            enableAutoLocation: true
        });

        geolocationControl.addEventListener("locationSuccess", function(e) {
            // 定位成功事件
            var address = '';
            address += e.addressComponent.province;
            address += e.addressComponent.city;
            address += e.addressComponent.district;
            address += e.addressComponent.street;
            address += e.addressComponent.streetNumber;
            console.log("当前定位地址为：" + address);

        });
        geolocationControl.addEventListener("locationError", function(e) {
            // 定位失败事件
            console.log(e.message);
        });
        map.addControl(geolocationControl);
        // **********************  添加定位控件 END  **********************

    }

    map() {
        // 自定义图标
        var myIcon = new BMap.Icon("http://developer.baidu.com/map/jsdemo/img/fox.gif", new BMap.Size(300,
            157));

        // 地图点击事件
        this.OnClick = function() {
            map.addEventListener('click', function(e) { //e包含了点击处的坐标
                console.clear();
                console.log(e);
                console.log('点击坐标: ' + e.point.lng + ', ' + e.point.lat); //获取经纬度
                //			map.clearOverlays(); //清除标注
                //			var mk = new BMap.Marker(e.point, {
                //				icon: myIcon
                //			}); //设置标注
                //			map.addOverlay(mk); //添加标注
                //			map.panTo(e.point); //移动指定位置到地图中心点
            });
        }

        // ********************** 在指定坐标添加一个标注 START **********************

        this.addMark = function(point) {
            var sContent =
                "<div>	<h4 style='margin:0 0 5px 0;padding:0.2em 0'>浏览器定位地址</h4>" +
                "<img style='float:right;margin:4px' id='imgDemo' src='' title=''/>" +
                "<p style='margin:0;line-height:1.5;font-size:13px;text-indent:2em;float: left'>以当前网络服务商的基站地址为准（坐标：" +
                point.lng + "," + point.lat + ")</p>" +
                "</div>";
            var infoWindow = new BMap.InfoWindow(sContent); // 创建信息窗口对象

            var mk = new BMap.Marker(point, {
                title: ""
            }); //使用默认的图标

            map.addOverlay(mk); //添加标注
            mk.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的标注,浏览器定位的时候setAnimation必须放在addOverlay之后才能实现跳动效果
            map.panTo(point); //以某点为中心
            mk.addEventListener("click", function() {
                this.openInfoWindow(infoWindow);
            })
        }
        // **********************  在指定坐标添加一个标注 END  **********************

        // ********************** 创建带简介的标注 START **********************

        /**
         * var sContent =
         * "<div>	<h4 style='margin:0 0 5px 0;padding:0.2em 0'>Dfer</h4>" +
         * "<img style='float:right;margin:4px' id='imgDemo' src='http://www.95bl.com/js/s.png' width='139' height='104' title='天安门'/>" +
         * "<p style='margin:0;line-height:1.5;font-size:13px;text-indent:2em'> 这网速，永远不知道从何卡起，又在什么时候结束，正所谓，十步卡一人，千里不留痕 ...</p>" +
         * "</div>";
         * Map.MarkPanel(111.326872, 30.739858, sContent);
         */
        this.MarkPanel = function(x, y, sContent) {
            if (x == 0) {
                x = 111.30321250169;
                y = 30.703429510055;
                ico = new BMap.Icon("http://www.dfer.top/faviconMix.ico", new BMap.Size(33, 33));
            } else
                ico = myIcon;

            var infoWindow = new BMap.InfoWindow(sContent); // 创建信息窗口对象
            var point = new BMap.Point(x, y);
            var marker = new BMap.Marker(point, {
                enableMassClear: false,
                shadow: ico,
                icon: ico,
                title: "跟Df来一场说走就走的旅行"
            });
            marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的标注
            map.addOverlay(marker);

            marker.addEventListener("click", function() {
                this.openInfoWindow(infoWindow);
            })
        }

        // **********************  创建带简介的标注 END  **********************

        // ********************** 创建地图右键菜单 START **********************

        this.OnClickRtButton = function() {
            var menu = new BMap.ContextMenu();
            // 创建选项
            var txtMenuItem = [{
                text: '放大',
                callback: function() {
                    map.zoomIn()
                }
            }, {
                text: '缩小',
                callback: function() {
                    map.zoomOut()
                }
            }];
            for (var i = 0; i < txtMenuItem.length; i++) {
                menu.addItem(new BMap.MenuItem(txtMenuItem[i].text, txtMenuItem[i].callback, 100)); //加载选项到右键菜单
            }
            map.addEventListener("tilesloaded", function() {
                // console.log("地图加载完毕——添加右键菜单");
                // 添加右键菜单到地图
                map.addContextMenu(menu);
            });
        }

        // **********************  创建地图右键菜单 END  **********************

        this.Loading = function() {
            // ********************** 显示地图加载进度 START **********************
            $("body").append("<div id='map_Loading'></div>");
            $("body").append("<div id='shadow'></div><div id='copyright'>陌上炊烟寥寥起，一壶浊酒醉平生——by Df</div>");
            $("#map_Loading").html("地图加载中...");
            Set一堆样式("#map_Loading", {
                "position": "absolute",
                "left": "3px",
                "height": "150px",
                "color": "#ff0000",
                "top": "1px"
            });
            Set一堆样式("#copyright", {
                "position": "absolute",
                "left": "0px",
                "height": "",
                "background": "rgb(0, 0, 0)",
                "color": "rgb(17, 241, 105)",
                "bottom": "0px",
                "width": "100%",
                "text-align": "right"
            });
            Set一堆样式("#shadow", {
                "position": "absolute",
                "left": "3px",
                "height": "30px",
                "width": "180px",
                "background": "rgb(0, 0, 0)",
                "bottom": "22px",
                "display": "none"
            });
            // **********************  显示地图加载进度 END  **********************

            // ********************** 地图加载完成之后执行 START **********************
            map.addEventListener("tilesloaded", function() {
                // console.log("地图加载完毕");
                // 加载完成之后隐藏
                隐藏("map_Loading");
            });
            // **********************  地图加载完成之后执行 END  **********************
        }
    }

    /**
     * 用经纬度设置地图中心点（移动到指定位置）和标注
     * @param {Object} x
     * @param {Object} y
     */
    setLocation(x, y) {
        if (x != "" && y != "") {
            var point = new BMap.Point(x, y); // 创建一个坐标（初始化地图时候的经纬度）
            map.centerAndZoom(point, 15); // 初始化地图，设置中心点坐标和地图缩放级别

            map.enableScrollWheelZoom(); //允许缩放
            map.addControl(new BMap.MapTypeControl({
                anchor: BMAP_ANCHOR_TOP_RIGHT
            })); //多种显示模式
            map.addControl(new BMap.NavigationControl()); //添加缩放平移控件
            map.addControl(new BMap.OverviewMapControl()); //缩略图
            map.addControl(new BMap.ScaleControl()); //添加比例尺控件

            var marker = new BMap.Marker(point); // 创建标注
            marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的标注
            map.addOverlay(marker); // 将标注添加到地图中
            map.panTo(new_point); //以某个坐标为地图中心点
        } else
            console.log("坐标不能为空!!!");
    }


}